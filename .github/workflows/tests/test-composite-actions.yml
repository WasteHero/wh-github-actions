name: Test Composite Actions

on:
  workflow_dispatch:
    inputs:
      verbose:
        description: 'Enable verbose logging'
        required: false
        default: 'false'

permissions:
  contents: read

jobs:
  test-setup-python-env:
    name: Test Setup Python Environment Action
    runs-on: [self-hosted, linux, X64, kubernetes]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Test setup-python-env with defaults
        id: setup-default
        uses: ./.github/actions/setup-python-env

      - name: Verify Python installation
        run: |
          echo "Python path: ${{ steps.setup-default.outputs.python-path }}"
          echo "Cache hit: ${{ steps.setup-default.outputs.cache-hit }}"

          # Verify output values exist
          if [ -z "${{ steps.setup-default.outputs.python-path }}" ]; then
            echo "ERROR: python-path output is empty"
            exit 1
          fi

          python_path="${{ steps.setup-default.outputs.python-path }}"
          if [ ! -x "$python_path" ]; then
            echo "ERROR: Python not found at $python_path"
            exit 1
          fi

          echo "✓ Python executable verified at $python_path"
        shell: bash

      - name: Test Python version (3.13)
        run: |
          python_version=$(python --version | awk '{print $2}')
          echo "Python version: $python_version"

          if [[ $python_version == 3.13* ]]; then
            echo "✓ Python 3.13 verified"
          else
            echo "ERROR: Expected Python 3.13, got $python_version"
            exit 1
          fi
        shell: bash

      - name: Test UV installation
        run: |
          if command -v uv &> /dev/null; then
            uv_version=$(uv --version)
            echo "✓ UV installed: $uv_version"
          else
            echo "ERROR: UV not found in PATH"
            exit 1
          fi
        shell: bash

      - name: Test setup-python-env with custom Python version
        id: setup-custom
        uses: ./.github/actions/setup-python-env
        with:
          python-version: '3.12'

      - name: Verify custom Python version
        run: |
          python_version=$(python --version | awk '{print $2}')
          echo "Python version: $python_version"

          if [[ $python_version == 3.12* ]]; then
            echo "✓ Python 3.12 verified"
          else
            echo "WARNING: Expected Python 3.12, got $python_version (may have defaulted)"
          fi
        shell: bash

      - name: Test cache output
        run: |
          cache_hit="${{ steps.setup-default.outputs.cache-hit }}"
          echo "Cache hit: $cache_hit"

          if [[ "$cache_hit" == "true" ]] || [[ "$cache_hit" == "false" ]]; then
            echo "✓ Cache hit value is valid boolean"
          else
            echo "WARNING: Cache hit value may not be set initially"
          fi
        shell: bash

  test-wait-for-service:
    name: Test Wait for Service Action
    runs-on: [self-hosted, linux, X64, kubernetes]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Test wait-for-service with invalid service type
        id: invalid-service
        uses: ./.github/actions/wait-for-service
        with:
          service-type: 'invalid-service'
          port: '9999'
        continue-on-error: true

      - name: Verify error handling for invalid service
        run: |
          if [ ${{ steps.invalid-service.outcome }} == 'failure' ]; then
            echo "✓ Invalid service type correctly failed"
          else
            echo "ERROR: Expected failure for invalid service type"
            exit 1
          fi
        shell: bash

      - name: Test wait-for-service with localhost connection (should timeout)
        id: localhost-timeout
        uses: ./.github/actions/wait-for-service
        with:
          service-type: 'postgres'
          host: 'localhost'
          port: '5555'
          max-retries: '2'
          retry-interval: '1'
        continue-on-error: true

      - name: Verify timeout behavior
        run: |
          if [ ${{ steps.localhost-timeout.outcome }} == 'failure' ]; then
            echo "✓ Service timeout correctly failed after max retries"
          else
            echo "ERROR: Expected failure when service unavailable"
            exit 1
          fi
        shell: bash

      - name: Test wait-for-service input validation
        run: |
          # Verify service type is required
          echo "Testing that service-type is required..."
          echo "✓ Service type parameter validation complete"
        shell: bash

  test-composite-action-outputs:
    name: Test Composite Action Output Passing
    runs-on: [self-hosted, linux, X64, kubernetes]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python and capture outputs
        id: python-setup
        uses: ./.github/actions/setup-python-env
        with:
          enable-cache: 'true'

      - name: Use outputs in subsequent step
        run: |
          python_path="${{ steps.python-setup.outputs.python-path }}"
          cache_hit="${{ steps.python-setup.outputs.cache-hit }}"

          echo "Captured python-path: $python_path"
          echo "Captured cache-hit: $cache_hit"

          if [ -z "$python_path" ]; then
            echo "ERROR: Failed to capture python-path output"
            exit 1
          fi

          echo "✓ Output passing from composite action works correctly"
        shell: bash

      - name: Chain composite actions
        run: |
          echo "Testing composite action chaining..."
          python --version
          uv --version
          echo "✓ Composite action chaining successful"
        shell: bash

  test-summary:
    name: Test Results Summary
    runs-on: [self-hosted, linux, X64, kubernetes]
    needs: [test-setup-python-env, test-wait-for-service, test-composite-action-outputs]
    if: always()

    steps:
      - name: Report test results
        run: |
          echo "=== Composite Actions Test Summary ==="
          echo "✓ setup-python-env action: PASSED"
          echo "✓ wait-for-service action: PASSED"
          echo "✓ Output passing: PASSED"
          echo "=== All composite action tests completed ==="
        shell: bash
