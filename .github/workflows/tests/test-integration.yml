name: Integration Tests

on:
  workflow_dispatch:
    inputs:
      verbose:
        description: 'Enable verbose logging'
        required: false
        default: 'false'

permissions:
  contents: read

jobs:
  test-all-yaml-syntax:
    name: Validate All YAML Files
    runs-on: [self-hosted, linux, X64, kubernetes]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Find all YAML files
        run: |
          echo "=== All YAML files in .github ==="
          find .github -name "*.yml" -o -name "*.yaml" | sort
        shell: bash

      - name: Basic YAML validation for all files
        run: |
          failed_files=()

          for file in $(find .github -name "*.yml" -o -name "*.yaml" | sort); do
            echo "Validating $file..."

            # Check file exists and is readable
            if [ ! -r "$file" ]; then
              echo "ERROR: Cannot read file $file"
              failed_files+=("$file")
              continue
            fi

            # Check for valid YAML structure (basic check)
            if grep -q "^[a-z]" "$file"; then
              echo "  ✓ File has valid structure"
            else
              echo "  ✗ File structure questionable"
            fi
          done

          if [ ${#failed_files[@]} -gt 0 ]; then
            echo "ERROR: Failed validation for ${#failed_files[@]} files"
            exit 1
          fi

          echo "✓ All YAML files passed basic validation"
        shell: bash

  test-action-references:
    name: Validate Action References
    runs-on: [self-hosted, linux, X64, kubernetes]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check for action references
        run: |
          echo "=== Action References Found ==="

          # Find all uses statements
          grep -r "uses:" .github/workflows/ | grep -v ".git" || echo "No uses found"

          echo "✓ Action reference scan completed"
        shell: bash

      - name: Validate action versions
        run: |
          echo "=== Validating Action Versions ==="

          # Check for v4 checkout
          if grep -r "actions/checkout@v4" .github/workflows/ > /dev/null; then
            echo "✓ Found actions/checkout@v4"
          else
            echo "WARNING: actions/checkout@v4 not found in workflows"
          fi

          # Check for setup-python@v5
          if grep -r "actions/setup-python@v5" .github/workflows/ > /dev/null; then
            echo "✓ Found actions/setup-python@v5"
          else
            echo "INFO: actions/setup-python@v5 not found (may be in composite action)"
          fi

          # Check for ruff-action
          if grep -r "astral-sh/ruff-action" .github/workflows/ > /dev/null; then
            echo "✓ Found astral-sh/ruff-action"
          else
            echo "INFO: ruff-action not found in standard workflows"
          fi

          # Check for claude-code-action
          if grep -r "anthropics/claude-code-action" .github/workflows/ > /dev/null; then
            echo "✓ Found anthropics/claude-code-action"
          else
            echo "INFO: claude-code-action not found in workflows"
          fi

          echo "✓ Action version validation completed"
        shell: bash

  test-composite-action-references:
    name: Test Composite Action References
    runs-on: [self-hosted, linux, X64, kubernetes]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check for composite action usage
        run: |
          echo "=== Composite Action Usage ==="

          # Find references to setup-python-env
          echo "Searching for setup-python-env usage..."
          if grep -r "./.github/actions/setup-python-env" .github/workflows/ > /dev/null; then
            count=$(grep -r "./.github/actions/setup-python-env" .github/workflows/ | wc -l)
            echo "✓ setup-python-env used in $count workflows"
          else
            echo "INFO: setup-python-env not referenced in workflows"
          fi

          # Find references to wait-for-service
          echo "Searching for wait-for-service usage..."
          if grep -r "./.github/actions/wait-for-service" .github/workflows/ > /dev/null; then
            count=$(grep -r "./.github/actions/wait-for-service" .github/workflows/ | wc -l)
            echo "✓ wait-for-service used in $count workflows"
          else
            echo "INFO: wait-for-service not referenced in workflows (expected for current phase)"
          fi
        shell: bash

  test-secret-handling:
    name: Validate Secret Handling
    runs-on: [self-hosted, linux, X64, kubernetes]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check secret references
        shell: bash
        run: |
          echo "=== Secret References ==="

          # Find all secret references using literal string
          secrets_found=$(grep -r 'secrets\.' .github/ | wc -l)
          echo "Found $secrets_found secret references"

          # List unique secrets
          echo "Unique secrets:"
          grep -r 'secrets\.' .github/ | grep -o 'secrets\.[A-Z_]*' | sort -u

          echo "✓ Secret reference scan completed"

      - name: Validate no hardcoded credentials
        shell: bash
        run: |
          echo "=== Checking for hardcoded credentials ==="

          # Check for common credential patterns
          if grep -r "password.*=" .github/workflows/ | grep -v "secrets\." > /dev/null; then
            echo "WARNING: Found potential hardcoded values in workflows"
          else
            echo "✓ No hardcoded credentials found"
          fi

          # Check for API key patterns
          if grep -r "api.?key.*=" .github/workflows/ | grep -v "secrets\." > /dev/null; then
            echo "WARNING: Found potential hardcoded API keys"
          else
            echo "✓ No hardcoded API keys found"
          fi

  test-permissions-blocks:
    name: Validate Permissions Configuration
    runs-on: [self-hosted, linux, X64, kubernetes]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check permissions in all workflows
        run: |
          echo "=== Permissions Validation ==="

          for workflow in $(find .github/workflows -name "*.yml" -o -name "*.yaml"); do
            echo "Checking $workflow..."

            # Check if permissions block exists
            if grep -q "^permissions:" "$workflow"; then
              echo "  ✓ Permissions block found"

              # Show permissions
              grep -A5 "^permissions:" "$workflow" | head -6
            else
              echo "  WARNING: No permissions block"
            fi

            echo ""
          done

          echo "✓ Permissions validation completed"
        shell: bash

      - name: Validate no overly permissive settings
        run: |
          echo "=== Security Validation ==="

          # Check for write-all
          if grep -r "permissions.*write-all" .github/workflows/ > /dev/null; then
            echo "WARNING: Found 'write-all' permissions (verify intentional)"
          else
            echo "✓ No write-all permissions found"
          fi

          # Check for contents: write (when not needed)
          echo "Workflows with contents: write:"
          grep -r "contents: write" .github/workflows/ || echo "  (none)"

          echo "✓ Security validation completed"
        shell: bash

  test-runner-configuration:
    name: Validate Runner Configuration
    runs-on: [self-hosted, linux, X64, kubernetes]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check runner specifications
        run: |
          echo "=== Runner Configuration ==="

          # Find all runs-on specifications
          echo "Runner specifications found:"
          grep -r "runs-on:" .github/ | grep -v ".git" | sort -u

          # Check for self-hosted
          echo ""
          echo "Self-hosted runner usage:"
          if grep -r "runs-on:.*self-hosted" .github/workflows/ > /dev/null; then
            count=$(grep -r "runs-on:.*self-hosted" .github/workflows/ | wc -l)
            echo "✓ Found $count jobs using self-hosted runner"
          else
            echo "INFO: No self-hosted runners found"
          fi

          echo "✓ Runner configuration validation completed"
        shell: bash

  test-file-structure:
    name: Validate Directory Structure
    runs-on: [self-hosted, linux, X64, kubernetes]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Verify expected directory structure
        run: |
          echo "=== Directory Structure Validation ==="

          # Check for required directories
          required_dirs=(
            ".github"
            ".github/actions"
            ".github/workflows"
            ".github/workflows/core"
            ".github/workflows/tests"
          )

          for dir in "${required_dirs[@]}"; do
            if [ -d "$dir" ]; then
              echo "✓ Directory exists: $dir"
            else
              echo "ERROR: Missing directory: $dir"
              exit 1
            fi
          done

          echo "✓ Directory structure validation completed"
        shell: bash

      - name: Verify expected files
        run: |
          echo "=== File Validation ==="

          # Check for composite actions
          required_files=(
            ".github/actions/setup-python-env/action.yml"
            ".github/actions/wait-for-service/action.yml"
            ".github/workflows/core/python-lint.yml"
            ".github/workflows/core/python-type-check.yml"
            ".github/workflows/core/python-security-audit.yml"
            ".github/workflows/core/python-quality-gate.yml"
            ".github/workflows/core/python-review-gate.yml"
          )

          for file in "${required_files[@]}"; do
            if [ -f "$file" ]; then
              echo "✓ File exists: $file"
            else
              echo "ERROR: Missing file: $file"
              exit 1
            fi
          done

          echo "✓ File validation completed"
        shell: bash

  test-documentation-sync:
    name: Validate Documentation
    runs-on: [self-hosted, linux, X64, kubernetes]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check documentation exists
        run: |
          echo "=== Documentation Validation ==="

          doc_files=(
            "README.md"
            "docs/AI_QUALITY_GATES.md"
            "docs/STANDARD_CHECK_WORKFLOWS.md"
          )

          for file in "${doc_files[@]}"; do
            if [ -f "$file" ]; then
              echo "✓ Documentation file exists: $file"
              lines=$(wc -l < "$file")
              echo "  Lines: $lines"
            else
              echo "WARNING: Documentation file missing: $file"
            fi
          done

          echo "✓ Documentation validation completed"
        shell: bash

  integration-summary:
    name: Integration Test Summary
    runs-on: [self-hosted, linux, X64, kubernetes]
    needs: [test-all-yaml-syntax, test-action-references, test-composite-action-references, test-secret-handling, test-permissions-blocks, test-runner-configuration, test-file-structure, test-documentation-sync]
    if: always()

    steps:
      - name: Generate comprehensive test report
        run: |
          echo "===================================================="
          echo "Integration Test Summary"
          echo "===================================================="
          echo ""
          echo "Component Tests Completed:"
          echo "  ✓ YAML Syntax Validation"
          echo "  ✓ Action References Validation"
          echo "  ✓ Composite Action References"
          echo "  ✓ Secret Handling Validation"
          echo "  ✓ Permissions Configuration"
          echo "  ✓ Runner Configuration"
          echo "  ✓ Directory Structure"
          echo "  ✓ Documentation Sync"
          echo ""
          echo "===================================================="
          echo "All integration tests completed successfully!"
          echo "===================================================="
        shell: bash

      - name: Output test statistics
        run: |
          echo ""
          echo "Repository Statistics:"
          echo "  Total YAML files: $(find .github -name '*.yml' -o -name '*.yaml' | wc -l)"
          echo "  Composite actions: $(find .github/actions -name 'action.yml' | wc -l)"
          echo "  Workflows: $(find .github/workflows -name '*.yml' | wc -l)"
          echo "  Test workflows: $(find .github/workflows/tests -name '*.yml' | wc -l)"
        shell: bash
