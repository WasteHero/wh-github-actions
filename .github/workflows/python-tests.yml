name: Python Tests

on:
  workflow_call:
    inputs:
      enable-postgresql:
        type: boolean
        default: false
        description: 'Enable PostgreSQL service dependency'

      enable-mongodb:
        type: boolean
        default: false
        description: 'Enable MongoDB service dependency'

      enable-valkey:
        type: boolean
        default: false
        description: 'Enable ValKey service dependency'

      enable-nats:
        type: boolean
        default: false
        description: 'Enable NATS service dependency'

      enable-vault:
        type: boolean
        default: false
        description: 'Enable HashiCorp Vault service dependency'

      python-versions:
        type: string
        default: '["3.13"]'
        description: 'JSON array of Python versions to test'

      pytest-args:
        type: string
        default: 'tests/ -v'
        description: 'Arguments passed to pytest'

      test-timeout:
        type: number
        default: 30
        description: 'Test job timeout in minutes'

    secrets:
      UV_INDEX_WASTEHERO_USERNAME:
        required: true
        description: 'WasteHero PyPI username'

      UV_INDEX_WASTEHERO_PASSWORD:
        required: true
        description: 'WasteHero PyPI password'

permissions:
  contents: read

jobs:
  test:
    name: Test with Python ${{ matrix.python-version }}
    runs-on: [self-hosted, linux, X64, kubernetes]

    strategy:
      fail-fast: false
      matrix:
        python-version: ${{ fromJson(inputs.python-versions) }}

    services:
      postgres:
        image: ${{ inputs.enable-postgresql && 'postgres:17-alpine' || '' }}
        env:
          POSTGRES_DB: test_iam
          POSTGRES_USER: test_iam
          POSTGRES_PASSWORD: test_iam
        ports:
          - 5432:5432
        options: >-
          --health-cmd "pg_isready -U test_iam"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 20

      mongodb:
        image: ${{ inputs.enable-mongodb && 'mongo:8.0' || '' }}
        env:
          MONGO_INITDB_DATABASE: test_iam
        ports:
          - 27017:27017
        options: >-
          --health-cmd "mongosh --eval 'db.adminCommand(\"ping\")'"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 10

      valkey:
        image: ${{ inputs.enable-valkey && 'valkey/valkey:8.0-alpine' || '' }}
        ports:
          - 6379:6379
        options: >-
          --health-cmd "valkey-cli ping"
          --health-interval 5s
          --health-timeout 3s
          --health-retries 10

      nats:
        image: ${{ inputs.enable-nats && 'nats:latest' || '' }}
        env:
          NATS_ARGS: "-js"
        ports:
          - 4222:4222

      vault:
        image: ${{ inputs.enable-vault && 'hashicorp/vault:1.18' || '' }}
        env:
          VAULT_DEV_ROOT_TOKEN_ID: test-root-token
          VAULT_DEV_LISTEN_ADDRESS: 0.0.0.0:8200
        ports:
          - 8200:8200

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # Inline setup-python-env composite action
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}

      - name: Install UV
        shell: bash
        run: |
          curl -LsSf https://astral.sh/uv/install.sh | sh
          echo "$HOME/.cargo/bin" >> $GITHUB_PATH

      - name: Setup UV Cache
        uses: actions/cache@v4
        with:
          path: ~/.cache/uv
          key: uv-${{ runner.os }}-${{ hashFiles('**/pyproject.toml', '**/uv.lock') }}
          restore-keys: |
            uv-${{ runner.os }}-

      # Service containers have health checks configured
      # GitHub Actions automatically waits for them to be healthy before starting steps
      # No manual wait-for-service steps needed

      - name: Install dependencies
        run: |
          uv sync --extra-index-url https://${{ secrets.UV_INDEX_WASTEHERO_USERNAME }}:${{ secrets.UV_INDEX_WASTEHERO_PASSWORD }}@pypi.wastehero.io/team/wastehero_libraries/+simple/
        shell: bash

      - name: Run tests
        run: uv run pytest ${{ inputs.pytest-args }}
        timeout-minutes: ${{ inputs.test-timeout }}
        shell: bash
        env:
          POSTGRES_URL: ${{ env.POSTGRES_URL }}
          MONGODB_URL: ${{ env.MONGODB_URL }}
          VALKEY_URL: ${{ env.VALKEY_URL }}
          NATS_URL: ${{ env.NATS_URL }}
          VAULT_ADDR: ${{ env.VAULT_ADDR }}
          VAULT_TOKEN: ${{ env.VAULT_TOKEN }}
