name: Claude Custom Agents

on:
  issue_comment:
    types: [created]
  pull_request_review_comment:
    types: [created]

permissions:
  contents: read
  pull-requests: write
  issues: write

jobs:
  custom-agent:
    runs-on: [self-hosted, linux, X64, kubernetes]
    # Only trigger when @claude mention is present in the comment
    if: contains(github.event.comment.body, '@claude')

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Checkout Claude agents
        uses: actions/checkout@v4
        with:
          repository: WasteHero/claude-development-environment
          path: .claude-dev-env
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Load custom agents
        run: |
          # Create agents directory
          mkdir -p .claude/agents

          # Load agents from development environment repository
          if [ -d .claude-dev-env/agents ]; then
            cp -r .claude-dev-env/agents/* .claude/agents/ || true
            echo "Custom agents loaded from claude-development-environment"
            ls -la .claude/agents/
          else
            echo "No custom agents found in repository"
          fi

          # Also check for agents in runner's home directory (fallback)
          if [ -d ~/.wastehero/agents ]; then
            cp -r ~/.wastehero/agents/* .claude/agents/ || true
            echo "Additional agents loaded from ~/.wastehero/agents"
          fi

      - name: Run Claude with custom agents
        uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          github_token: ${{ secrets.GITHUB_TOKEN }}
          claude_args: "--model claude-haiku-4-5-20251001 --max-turns 10"
          # No prompt specified - responds to @claude mentions in comments

      - name: Handle workflow errors
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number || context.payload.pull_request.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: '⚠️ Claude Custom Agent workflow encountered an error. Please check the workflow logs.'
            });
