name: Claude Custom Agents

on:
  workflow_call:
    secrets:
      ANTHROPIC_API_KEY:
        required: true
      GITHUB_TOKEN:
        required: true

permissions:
  contents: read
  pull-requests: write
  issues: write

concurrency:
  group: claude-${{ github.event.issue.number || github.event.pull_request.number }}
  cancel-in-progress: false

jobs:
  claude-agent:
    runs-on: [self-hosted, linux, X64, kubernetes]
    timeout-minutes: 15

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Claude Code
        run: |
          # Install Claude Code CLI
          curl -fsSL https://claude.ai/install.sh | bash
          echo "$HOME/.local/bin" >> $GITHUB_PATH

      - name: Extract prompt
        id: extract
        run: |
          # Handle different event types
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            # For PR events, ask Claude to review the PR
            echo "Review this pull request and provide feedback on the code changes." > /tmp/claude-prompt.txt
          else
            # For comment events, extract the comment text (remove @claude mention)
            COMMENT="${{ github.event.comment.body }}"
            PROMPT=$(echo "$COMMENT" | sed 's/@claude//g' | sed 's/^[[:space:]]*//g')
            echo "$PROMPT" > /tmp/claude-prompt.txt
          fi

      - name: Run Claude CLI
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          # Run Claude in plain text conversational mode
          # --print: non-interactive mode
          # --output-format text: plain text output (no JSON)
          # --no-session-persistence: prevent loading cached config with json-schema
          claude --print \
            --output-format text \
            --no-session-persistence \
            --model claude-haiku-4-5-20251001 \
            --max-turns 10 \
            "$(cat /tmp/claude-prompt.txt)" \
            > /tmp/claude-response.txt 2>&1

          # Validate response
          if [ ! -s /tmp/claude-response.txt ]; then
            echo "Error: Claude produced no output" >&2
            exit 1
          fi

      - name: Post Claude response
        if: success()
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const response = fs.readFileSync('/tmp/claude-response.txt', 'utf8').trim();

            const issueNumber = context.issue.number || context.payload.pull_request.number;
            if (issueNumber && response) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issueNumber,
                body: '## ü§ñ Claude Response\n\n' + response
              });
            }

      - name: Handle workflow errors
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            const issueNumber = context.issue.number || context.payload.pull_request.number;
            if (issueNumber) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issueNumber,
                body: '‚ö†Ô∏è Claude workflow encountered an error. Please check the [workflow logs](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}) for details.'
              });
            }
