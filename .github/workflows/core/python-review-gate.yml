name: Python Review Gate

on:
  workflow_call:
    secrets:
      ANTHROPIC_API_KEY:
        required: true
        description: Anthropic API key for Claude Code

permissions:
  contents: read
  pull-requests: write

jobs:
  python-review-gate:
    name: Run Python Code Review
    runs-on: [self-hosted, linux, X64, kubernetes]

    steps:
      - name: Checkout code with full history
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Run Python code review with Claude
        id: code-review
        uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          prompt: |
            Run @agent-py-reviewer to conduct a comprehensive code review of Python files in this pull request.

            Focus on these areas:
            - Code quality and best practices
            - Performance issues
            - Security vulnerabilities
            - Test coverage

            Output findings in this format:
            - Issue category (Quality/Performance/Security/Testing)
            - Issue description
            - File and line number
            - Recommended fix

            If NO significant issues found, output: "âœ… No significant issues found in code review"
          claude_args: "--model claude-haiku-4-5-20251001 --max-turns 5"

      - name: Post review findings to PR
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            const output = `${{ steps.code-review.outputs.result }}`;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `## Python Code Review\n\n${output}`
            });

      - name: Determine review gate result
        id: review-result
        run: |
          output="${{ steps.code-review.outputs.result }}"

          if [[ "$output" == *"No significant issues found"* ]]; then
            echo "result=pass" >> $GITHUB_OUTPUT
            echo "Review gate PASSED: No significant issues found"
          else
            echo "result=fail" >> $GITHUB_OUTPUT
            echo "Review gate FAILED: Issues found"
          fi

      - name: Fail workflow if issues found
        if: steps.review-result.outputs.result == 'fail'
        run: |
          echo "Review gate failed - issues detected during code review"
          exit 1
